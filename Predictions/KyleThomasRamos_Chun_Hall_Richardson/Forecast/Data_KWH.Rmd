---
title: "isps forecast"
output: html_document
date: "2024-10-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
remotes::install_github("kuriwaki/ccesMRPprep")
library(ccesMRPprep)
```

```{r}
data_2008 = cd_info_2008

data_2012 = cd_info_2012

data_2016 = cd_info_2016

data_2020 = cd_info_2020

```

```{r}

#add on pct_mccain from data_2008
data_2020 = merge(data_2020, data_2008[,c("cd","pct_mccain")], by = "cd", all.x = TRUE)

colnames(data_2020)[which(colnames(data_2020) == "presvotes_total_20")] = "presvotes_total_2020"

#merge on presvotes_total and presvotes_DR from data_2008, data_2012, data_2016 onto data_2020 by cd; rename presvotes_total to presvotes_total_2008, presvotes_total_2012, presvotes_total_2016, and presvotes_total_2020
data_2020 = merge(data_2020, data_2008[,c("cd","presvotes_total")], by = "cd", all.x = TRUE)
data_2020 = merge(data_2020, data_2008[,c("cd","presvotes_DR")], by = "cd", all.x = TRUE)
colnames(data_2020)[which(colnames(data_2020) == "presvotes_total")] = "presvotes_total_2008"
colnames(data_2020)[which(colnames(data_2020) == "presvotes_DR")] = "presvotes_DR_2008"

data_2020 = merge(data_2020, data_2012[,c("cd","presvotes_total")], by = "cd", all.x = TRUE)
data_2020 = merge(data_2020, data_2012[,c("cd","presvotes_DR")], by = "cd", all.x = TRUE)
colnames(data_2020)[which(colnames(data_2020) == "presvotes_total")] = "presvotes_total_2012"
colnames(data_2020)[which(colnames(data_2020) == "presvotes_DR")] = "presvotes_DR_2012"

colnames(data_2020)[which(colnames(data_2020) == "presvotes_total_16")] = "presvotes_total_2016"
colnames(data_2020)[which(colnames(data_2020) == "presvotes_DR_16")] = "presvotes_DR_2016"
colnames(data_2020)[which(colnames(data_2020) == "presvotes_DR_20")] = "presvotes_DR_2020"

```


```{r}

#split the cd column on the hyphen in data_2020 so I have a state column, the first two characters and a district column, the last two characters
data_2020$state = substr(data_2020$cd, 1, 2)
data_2020$district = substr(data_2020$cd, 4, 5)
```

```{r}

# Your existing dataframe
df <- data_2020  # Replace with your actual dataframe name

# Years you want to include
years <- c(2008, 2012, 2016, 2020, 2024)

# Replicate each row for each year
df_expanded <- df[rep(1:nrow(df), each = length(years)), ]

# Assign the years to the 'year' column
df_expanded$year <- rep(years, times = nrow(df))

# View the expanded dataframe
head(df_expanded)

```

```{r}
#now let us add a row pct_r; if the year is 2008 then it will equal pct_mccain, if the year is 2012 then it will equal pct_romney, if the year is 2016 then it will equal pct_trump16, and if the year is 2020 then it will equal pct_trump; similarly, let us add a row presvotes_total; if the year is 2008 then it will equal presvotes_total_2008, if the year is 2012 then it will equal presvotes_total_2012, if the year is 2016 then it will equal presvotes_total_2016, and if the year is 2020 then it will equal presvotes_total_2020

df_expanded$pct_r = ifelse(df_expanded$year == 2008, df_expanded$pct_mccain, ifelse(df_expanded$year == 2012, df_expanded$pct_romney, ifelse(df_expanded$year == 2016, df_expanded$pct_trump16, df_expanded$pct_trump)))

df_expanded$presvotes_total = ifelse(df_expanded$year == 2008, df_expanded$presvotes_total_2008, ifelse(df_expanded$year == 2012, df_expanded$presvotes_total_2012, ifelse(df_expanded$year == 2016, df_expanded$presvotes_total_2016, df_expanded$presvotes_total_2020)))

df_expanded$presvotes_DR = ifelse(df_expanded$year == 2008, df_expanded$presvotes_DR_2008, ifelse(df_expanded$year == 2012, df_expanded$presvotes_DR_2012, ifelse(df_expanded$year == 2016, df_expanded$presvotes_DR_2016, df_expanded$presvotes_DR_2020)))

```

```{r}
#now create a new dataframe from df_expanded only with the columns state, district, dailykos_name, largest_place, year, pct_r, and presvotes_total

data_complete = df_expanded[,c("state","district","dailykos_name","largest_place","year","pct_r","presvotes_total", "presvotes_DR")]

```

```{r}
#adding congressional data
congressional_data = read.csv('data/c_data.csv')

#filter the data so I only have rows where office is "H" or "S" and party formal is "R"; then return only the columns state, district, year, office, incumbency, votes_earned, and total votes

congressional_data = congressional_data[congressional_data$office %in% c("H","S") & congressional_data$party_formal == "R" & congressional_data$year %in% c(2008, 2012, 2016, 2020),]

congressional_data = congressional_data[,c("state","district","year","office","incumbency","votes_earned","total_votes")]

```

```{r}
#add a row to complete_data for H_pct_r (votes_earned/total_votes) and S_pct_r (votes_earned/total_votes) and H_total_votes and S_total_votes

congressional_data$H_votes_r = ifelse(congressional_data$office == "H", congressional_data$votes_earned, NA)

congressional_data$S_votes_r = ifelse(congressional_data$office == "S", congressional_data$votes_earned, NA)

congressional_data$H_total_votes = ifelse(congressional_data$office == "H", congressional_data$total_votes, NA)

congressional_data$S_total_votes = ifelse(congressional_data$office == "S", congressional_data$total_votes, NA)

congressional_data$H_pct_r = ifelse(congressional_data$office == "H", congressional_data$votes_earned/congressional_data$total_votes, NA)

```

```{r}

#add a row to complete_data for H_total_votes and S_total_votes and H_pct_r and S_pct_r; merge on state, district, and year; if there is no match, then NA

congressional_data$district = as.character(congressional_data$district)
data_complete$district = as.character(data_complete$district)

congressional_data$district = ifelse(nchar(congressional_data$district) == 1, paste("0",congressional_data$district,sep = ""), congressional_data$district)

data_complete = merge(data_complete, congressional_data[,c("state","district","year","H_votes_r", "H_pct_r","H_total_votes","incumbency")], by = c("state","district","year"), all.x = TRUE)

```

```{r}

#let us try making an lm that predicts H_total_votes from presvotes_total, state, and pct_r

data_complete$state_dist = paste(data_complete$state, data_complete$district, sep = "")

mod_4.2_a = lm(H_total_votes ~ presvotes_total + factor(state_dist) + pct_r, data = data_complete)

summary(mod_4.2_a)


```

```{r}
#adding Liam's data

liam_data = read.csv('data/data_complete_plus_census.csv')
census_data_2024 = read.csv('data/census2024collapse.csv')

liam_data$state = as.character(liam_data$state.x)
census_data_2024$district <- as.numeric(sub(".*-", "", census_data_2024$cd))


census_data_2024$year = 2024

liam_data_b = liam_data[,c("state","district","year","total_population","pct_male", "pct_18_and_older", "pct_senior", "median_age", "pct_white", "pct_black", "pct_amer_indian", "pct_asian", "pct_pi", "pct_latino", "total_housing_units", "est_voting_age_pop", "voting_age_pop_over_total")]

census_data_2024 = census_data_2024[,c("state","district","year","total_population","pct_male", "pct_18_and_older", "pct_senior", "median_age", "pct_white", "pct_black", "pct_amer_indian", "pct_asian", "pct_pi", "pct_latino", "total_housing_units", "est_voting_age_pop", "voting_age_pop_over_total")]

#add census_data_2024 to liam_data_b
liam_data_c = rbind(liam_data_b, census_data_2024)

```

```{r}

#make district in data_complete a number
data_complete$district = as.numeric(data_complete$district)
liam_data_c$district = as.numeric(liam_data_c$district)

data_complete$state = as.character(data_complete$state)
liam_data_c$state = as.character(liam_data_c$state)

data_complete$year = as.numeric(data_complete$year)
liam_data_c$year = as.numeric(liam_data_c$year)

#when the year is 2024, pct_r, presvotes_total, and presvotes_DR are NA
data_complete$pct_r[data_complete$year == 2024] = NA
data_complete$presvotes_total[data_complete$year == 2024] = NA
data_complete$presvotes_DR[data_complete$year == 2024] = NA

#merge onto data_complete by state, district, and year from liam_data_c total_population, pct_male, pct_pct_18_and_older, pct_senior, median_age, pct_white, pct_black, pct_amer_indian, pct_asian, pct_pi, pct_latino, total_housing_units, est_voting_age_pop, voting_age_pop_over_total

final_data = merge(data_complete, liam_data_c, by = c("state","district","year"), all.x = TRUE)

```

```{r}
#df where I have state, district, year, pct_r, and presvotes_total

temp_data = final_data[,c("state","district","year","pct_r","presvotes_total")]

#for each state and district, I want to make a new variable called pct_r_ratio that is the pct_r in that row divided by the pct_r in the row where year is 2008 for that same state and district

temp_data$pct_r_ratio = NA

for(i in 1:nrow(temp_data)){
  temp_data$pct_r_ratio[i] = temp_data$pct_r[i]/temp_data$pct_r[temp_data$year == 2008 & temp_data$state == temp_data$state[i] & temp_data$district == temp_data$district[i]]
}

#graph pct_r_ratio by year

library(ggplot2)

ggplot(temp_data, aes(x = year, y = pct_r_ratio)) + geom_point() + geom_smooth(method = "lm")

```











```{r}
library(writexl)

write_xlsx(final_data, "data/final_data.xlsx")

```

```{r}
Final_data_V2 = read.csv('data/full_district_data.csv')

```





