---
title: "ISPS - Election Forecasting"
author: "Liam Richardson"
date: "2024-10-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Phase 1 â€” Predicting the Presidential Vote Margin

Briefly, in our model, we want to predict all races downstream of the presidential race.
This stems from a 

```{r}
library(dplyr)
library(stringr)
#install.packages("remotes")
library(remotes)
remotes::install_github("kuriwaki/ccesMRPprep")
library(ccesMRPprep)
#install.packages("data.table")
library(data.table)
library(tidyr)
```


2024 election data
```{r}
#scraped these basic details from Wikipedia, only place we found with data in table format
houseraces2024 <- read.csv("/Users/liam/Downloads/courses/PLSC_204/ISPS Election Prediction/2024houseraces.csv")

#table(houseraces2024$Status)

houseraces2024 <- houseraces2024 %>% 
  mutate(d_cand = ifelse(Status == "Incumbent running unopposed." & Party == "Republican", FALSE, TRUE))
houseraces2024 <- houseraces2024 %>% 
  mutate(r_cand = ifelse(Status == "Incumbent running unopposed." & Party == "Democrat", FALSE, TRUE))

incumbency_vec <- c("Incumbent advanced to general.", "Incumbent renominated.", "Incumbent renominated..", "Incumbent renonimated", "Incumbent running.", "Incumbent running unopposed.")
  
houseraces2024 <- houseraces2024 %>% 
  mutate(incumb = ifelse(Status %in% incumbency_vec, 1, 0))
houseraces2024 <- houseraces2024 %>% 
  mutate(incumbency = case_when(
    (incumb == 1 & Party == "Republican") ~ 1,
    (incumb == 1 & Party == "Democratic") ~ -1,
    TRUE ~ 0))

#need house races to have a similar cd variable
houseraces2024$district <- houseraces2024$cd
houseraces2024$cd <- gsub("at-large", "1", houseraces2024$cd)
houseraces2024$cd <- state.abb[match(houseraces2024$cd, state.name)]
houseraces2024$district <- str_split_i(houseraces2024$cd, " ", -1)
houseraces2024$state <- gsub(" \\d+", "", houseraces2024$cd,)
houseraces2024$state_ab <- state.abb[match(houseraces2024$state, state.name)]
houseraces2024$cd <- paste0(houseraces2024$state_ab, "-", houseraces2024$district)

senateraces2024 <- read.csv("/Users/liam/Downloads/courses/PLSC_204/ISPS Election Prediction/2024senateraces.csv")

#table(senateraces2024$Result)

incumbency_vec_b <- c("Incumbent renominated.", "Incumbent running.")

#not adding a variable for whether someone is running unopposed on the senate level because I don't think it's happening at all on the senate level (and also it would be hard to account for unusual powerful independent incumbents, like Bernie Sanders and Jon Tester)

senateraces2024 <- senateraces2024 %>% 
  mutate(incumb = ifelse(Result %in% incumbency_vec_b, 1, 0))
senateraces2024 <- senateraces2024 %>% 
  mutate(incumbency = case_when(
    (incumb == 1 & Party == "Republican") ~ 1,
    (incumb == 1 & Party == "Democratic") ~ -1,
    TRUE ~ 0))
colnames(senateraces2024)[1] <- "state"
senateraces2024$state_ab <- state.abb[match(senateraces2024$state, state.name)]

#write.csv(houseraces2024,"~/Downloads/house2024cenus.csv", row.names = FALSE)

```

creating a composite dataset on the district level
```{r}
cd2008 <- cd_info_2008

cd2012 <- cd_info_2012

cd2012$pct_r_1 <- cd2012$pct_romney
cd2012$presvotes_1 <- cd2012$presvotes_total
cd2012$pct_r_0 <- cd2012$pct_mccain
cd2012$presvotes_0 <- NA
#cd2012$pct_r_0 <- cd2008$presvotes_total #don't think we can do this because of redistricting

cd2016 <- cd_info_2016

cd2016$pct_r_1 <- cd2016$pct_trump
cd2016$presvotes_1 <- cd2016$presvotes_total
cd2016$pct_r_0 <- cd2016$pct_romney
cd2016$presvotes_0 <- cd2012$presvotes_total

#cd2018 <- cd_info_2018

cd2020 <- cd_info_2020

cd2020$pct_r_1 <- cd2020$pct_trump
cd2020$presvotes_1 <- cd2020$presvotes_total
cd2020$pct_r_0 <- cd2020$pct_trump16
cd2020$presvotes_0 <- cd2016$presvotes_total #can generallydo this because of shared dimensionality / ordering / district lines

#cd2022 <- cd_info_2022

cd2024 <- cd_info_2024

#can do the following because cd_info_2024 uses 2024 boundaries.
cd2024$pct_r_0 <- cd2024$pct_trump20
cd2024$presvotes_0 <- cd2024$presvotes_total20
cd2024$pct_r_1 <- NA
cd2024$presvotes_1 <- NA

#reducing columns
cd2012 <- cd2012[,colnames(cd2012) %in% c("year", "cd", "presvotes_1", "pct_r_1", "presvotes_0", "pct_r_0")]
cd2016 <- cd2016[,colnames(cd2016) %in% c("year", "cd", "presvotes_1", "pct_r_1", "presvotes_0", "pct_r_0")]
cd2020 <- cd2020[,colnames(cd2020) %in% c("year", "cd", "presvotes_1", "pct_r_1", "presvotes_0", "pct_r_0")]
cd2024 <- cd2024[,colnames(cd2024) %in% c("year", "cd", "presvotes_1", "pct_r_1", "presvotes_0", "pct_r_0")]

collective_pres_district_returns <- rbind(cd2012, cd2016, cd2020, cd2024) %>%
  rename (pct_pres_time_1 = pct_r_1,
          pct_pres_time_0 = pct_r_0)
```

```{r}
#want to eventually sync this with congressional election returns
congress_elections <- read.csv("/Users/liam/Downloads/courses/PLSC_204/ISPS Election Prediction/congress_elections.csv")

#adding incumbency variable (would be nice to have an opposition variable but I don't think it's doable with our 2024 candidate data)
congress_elections_modern <- subset(congress_elections, congress_elections$year >= 2012)

congress_elections_modern <- congress_elections_modern %>% 
  mutate(incumbency = case_when(
      inc_d == "Incumbent" ~ -1,
      inc_r == "Incumbent" ~ 1,
      TRUE ~ 0)) 

congress_elections_modern <- congress_elections_modern %>% 
  mutate(r_cand = ifelse(is.na(votes_r), FALSE, TRUE))
congress_elections_modern <- congress_elections_modern %>% 
  mutate(d_cand = ifelse(is.na(votes_d), FALSE, TRUE))

congress_elections_modern %>% replace_na(list(votes_r = 0))
congress_elections_modern <- congress_elections_modern %>% 
  mutate(pct_r_congress_race = votes_r/votes_total)

#creating a district by district dataset (which includes congressional elections)  
house_elections_modern <- subset(congress_elections_modern, congress_elections_modern$office == "H")

house_elections_modern <- house_elections_modern %>% 
  mutate(cd = paste0(state_abbrev, "-", dist))

house_elections_modern_merge <- house_elections_modern[,colnames(house_elections_modern) %in% c("state_abbrev", "office", "year", "votes_total", "win_party", "incumbency", "r_cand", "d_cand", "pct_r_congress_race", "cd")]

senate_elections_modern <- subset(congress_elections_modern, congress_elections_modern$office == "S")

senate_elections_modern_merge <- senate_elections_modern[,colnames(senate_elections_modern) %in% c("state_abbrev", "office", "year", "votes_total", "win_party", "incumbency", "r_cand", "d_cand", "pct_r_congress_race")]

```

Next, creating a consolidated district dataset for all presidential returns and house returns
```{r}
#start by adding 2024 basic house data to previous house elections (which involves filling NAs for outcome results)
houseraces2024$year <- 2024
houseraces2024$votes_total <- NA
houseraces2024$win_party <- NA
houseraces2024$pct_r_congress_race <- NA
houseraces2024 <- houseraces2024[,!colnames(houseraces2024) %in% c("PVI", "Member", "Party", "Status", "state", "incumb", "district")]

house_elections_modern_merge <- house_elections_modern_merge %>%
  rename(state_ab = state_abbrev)
house_elections_modern_merge <- house_elections_modern_merge[,!colnames(house_elections_modern_merge) %in% c("office")]

bind_house <- rbind(house_elections_modern_merge, houseraces2024)
bind_house <- bind_house[order(bind_house$cd),]
#for uniformity, replace -0s with -1 in cd 
#table(bind_house_2024$cd)
bind_house$cd <- gsub("-0", "-1", bind_house$cd)

#we're only interested in data for years with presidential elections or census data
bind_house_pres_years <- subset(bind_house, year %in% c(2012, 2016, 2020, 2024))

#merging with presidential data
#first need to remove -0 and replace them with a -
collective_pres_district_returns$cd <- gsub("-0", "-", collective_pres_district_returns$cd)

presidential_plus_house_data <- merge(collective_pres_district_returns, bind_house_pres_years, by=c("cd", "year"))
```
combining with census data (processed in code below)
```{r}
census2012_avg_estimates <- read.csv("/Users/liam/Downloads/courses/PLSC_204/ISPS Election Prediction/census2012collapse.csv")
census2016_avg_estimates <- read.csv("/Users/liam/Downloads/courses/PLSC_204/ISPS Election Prediction/census2016collapse.csv")
census2020_avg_estimates <- read.csv("/Users/liam/Downloads/courses/PLSC_204/ISPS Election Prediction/census2020collapse.csv")
census2024_avg_estimates <- read.csv("/Users/liam/Downloads/courses/PLSC_204/ISPS Election Prediction/census2024collapse.csv")

census2012_avg_estimates$est_voting_age_pop <- NA
census2012_avg_estimates$voting_age_pop_over_total <- NA

collective_census_avg_estimates <- rbind(census2012_avg_estimates, census2016_avg_estimates, census2020_avg_estimates, census2024_avg_estimates)

full_district_data <- merge(presidential_plus_house_data, collective_census_avg_estimates, by=c("cd","year", "state_ab"))

#time 1 equals this cycle, #time 0 equals past cycle
#pct 
full_district_data_rename <- full_district_data %>%
  rename(rep_pct_pres_now = pct_pres_time_1,
         presvotes_total_now = presvotes_1,
         rep_pct_pres_last = pct_pres_time_0,
         presvotes_total_last = presvotes_0,
         house_votes_total = votes_total,
         house_win_party = win_party,
         house_incumbency = incumbency, #1 equals republican incumbent, -1 equals democratic incumbent, 0 = neither
         r_cand_house = r_cand, #is there a republican candidate for house? if FALSE, dem is presumably unopposed
         d_cand_house = d_cand, #like above but flipped d_cand_house = FALSE means Rep is unopposed
         rep_pct_house_race = pct_r_congress_race
         )#

write.csv(full_district_data_rename,"~/Downloads/full_district_data.csv", row.names = FALSE)

```


```{r}
cpvi2012 <- read.csv("/Users/liam/Downloads/courses/PLSC_204/ISPS Election Prediction/2012cpvi.csv") #use 2012 for correct districts but lag of one-year prior for consistency across other elections
cpvi2016 <- read.csv("/Users/liam/Downloads/courses/PLSC_204/ISPS Election Prediction/2015cpvi.csv")
cpvi2020 <- read.csv("/Users/liam/Downloads/courses/PLSC_204/ISPS Election Prediction/2019cpvi.csv")
cpvi2024 <- read.csv("/Users/liam/Downloads/courses/PLSC_204/ISPS Election Prediction/2023cpvi.csv")


#general procedure to clean
cpvi2012$year <- 2012

cpvi2012$cd <- cpvi2012$Dist

cpvi2012$cd <- gsub("-00", "-1", cpvi2012$cd)
cpvi2012$cd <- gsub("-0", "-", cpvi2012$cd)

cpvi2012$margin_party <- str_split_fixed(cpvi2012$X2012.Raw.PVI, "\\+", 2)[,1]
cpvi2012$margin_num <- as.numeric(str_split_fixed(cpvi2012$X2012.Raw.PVI, "\\+", 2)[,2])

cpvi2012 <- cpvi2012 %>%
  mutate(relative_partisanship_CPVI = case_when(
    (margin_party == "R") ~ margin_num,
    (margin_party == "D") ~ margin_num * -1,
    TRUE ~ 0))

cpvi2012_merge <- cpvi2012[,colnames(cpvi2012) %in% c("cd", "year", "relative_partisanship_CPVI")]
   
#cleaning 2016
cpvi2016$year <- 2016

cpvi2016$cd <- cpvi2016$Dist

cpvi2016$cd <- gsub("-00", "-1", cpvi2016$cd)
cpvi2016$cd <- gsub("-0", "-", cpvi2016$cd)

cpvi2016$margin_party <- str_split_fixed(cpvi2016$X2015.Raw.PVI, "\\+", 2)[,1]
cpvi2016$margin_num <- as.numeric(str_split_fixed(cpvi2016$X2015.Raw.PVI, "\\+", 2)[,2])

cpvi2016 <- cpvi2016 %>%
  mutate(relative_partisanship_CPVI = case_when(
    (margin_party == "R") ~ margin_num,
    (margin_party == "D") ~ margin_num * -1,
    TRUE ~ 0))

cpvi2016_merge <- cpvi2016[,colnames(cpvi2016) %in% c("cd", "year", "relative_partisanship_CPVI")]

#cleaning 2020
cpvi2020$year <- 2020

cpvi2020$cd <- cpvi2020$Dist

cpvi2020$cd <- gsub("-AL", "-1", cpvi2020$cd)
cpvi2020$cd <- gsub("-0", "-", cpvi2020$cd)

cpvi2020$margin_party <- str_split_fixed(cpvi2020$X2019.Raw.PVI, "\\+", 2)[,1]
cpvi2020$margin_num <- as.numeric(str_split_fixed(cpvi2020$X2019.Raw.PVI, "\\+", 2)[,2])

cpvi2020 <- cpvi2020 %>%
  mutate(relative_partisanship_CPVI = case_when(
    (margin_party == "R") ~ margin_num,
    (margin_party == "D") ~ margin_num * -1,
    TRUE ~ 0))

cpvi2020_merge <- cpvi2020[,colnames(cpvi2020) %in% c("cd", "year", "relative_partisanship_CPVI")]

#cleaning 2024
cpvi2024$year <- 2024

cpvi2024$cd <- cpvi2024$Dist

cpvi2024$cd <- gsub("-AL", "-1", cpvi2024$cd)
cpvi2024$cd <- gsub("-0", "-", cpvi2024$cd)

cpvi2024$margin_party <- str_split_fixed(cpvi2024$X2023.Raw.PVI, "\\+", 2)[,1]
cpvi2024$margin_num <- as.numeric(str_split_fixed(cpvi2024$X2023.Raw.PVI, "\\+", 2)[,2])

cpvi2024 <- cpvi2024 %>%
  mutate(relative_partisanship_CPVI = case_when(
    (margin_party == "R") ~ margin_num,
    (margin_party == "D") ~ margin_num * -1,
    TRUE ~ 0))

cpvi2024_merge <- cpvi2024[,colnames(cpvi2024) %in% c("cd", "year", "relative_partisanship_CPVI")]

cpvi_full <- rbind(cpvi2012_merge, cpvi2016_merge, cpvi2020_merge, cpvi2024_merge)
 
#adding relative partisanship to full district data
full_district_data_plus_cpvi <- merge(full_district_data_rename, cpvi_full, by=c("cd","year"))

write.csv(full_district_data_plus_cpvi,"~/Downloads/full_district_data_v2.csv", row.names = FALSE)

```



Next, creating a consolidated district dataset for all presidential returns and senate returns

creating a composite dataset on the state level

```{r}

```
Want to add DC-01 to this (even though it's not a typical congressional district)

```{r}
#This is all for 20XX data, but for expediency, I'm not changing the code (except where data is imported) until the end

census_oneyear <- read.csv("/Users/liam/Downloads/courses/PLSC_204/ISPS Election Prediction/one_year_census/ACSDP1Y2023.DP05-Data.csv")

census_oneyear_original <- census_oneyear #backup

#renaming columns to something more typically recognizable
colnames(census_oneyear) <- census_oneyear[1,]
census_oneyear <- census_oneyear[-1,]

colnames(census_oneyear)[colnames(census_oneyear) == "Geographic Area Name"] = "name"

#removing duplicate rows and columns (weirdly every row was duplicated in 2017 and columns are regularly duplicated)
census_oneyear <- distinct(census_oneyear)
census_oneyear <- census_oneyear[!duplicated(as.list(census_oneyear))]

#renaming rows so the indexing isn't wrong
rownames(census_oneyear) <- NULL 

#adding a new state column (for merging with congressional district dataset)
census_oneyear$state <- str_split_fixed(census_oneyear$name, ", ", 2)[,2]
#using regex state abbreviations in R to recode states as abbreviation
census_oneyear$state_ab <- state.abb[match(census_oneyear$state, state.name)]
#looking at NA rows (since we want to preserve DC)
census_NAstate <- census_oneyear[is.na(census_oneyear$state_ab),]

string_dc <- census_oneyear$Geography[census_oneyear$name == census_NAstate$name[1]]
string_pr <- census_oneyear$Geography[census_oneyear$name == census_NAstate$name[2]]

census_oneyear$state_ab[census_oneyear$Geography == string_dc] <- "DC" #giving DC a "state" abbreviation
census_oneyear <- census_oneyear[!census_oneyear$Geography == string_pr, ] #removing PR

#coding district number
census_oneyear$districtnum <- str_split_fixed(census_oneyear$name, " \\(", 2)[,1]
census_oneyear$districtnum[census_oneyear$districtnum == "Congressional District"] <- "Congressional District 1"
census_oneyear$districtnum[census_oneyear$districtnum == "Delegate District"] <- "Congressional District 1" #for DC 
census_oneyear$num <- str_split_fixed(census_oneyear$districtnum, " ", 3)[,3]
#table(census_oneyear$districtnum)

#creating a district column with the same formatting as in our CD election info dataframe
census_oneyear$cd <- paste(census_oneyear$state_ab, census_oneyear$num, sep="-")

```


```{r}
#now that our data can more easily be merged with the data above, we clear it up to better serve our purposes
#colnames(census_oneyear)

#str_split_fixed(census_oneyear$name, "\\!\\!", 2)[,1]

#for next phase, create a new dataframe
census_c <- census_oneyear

#We don't have use for the margin of error columns for our complexixty of model
census_c[nrow(census_c) +1,] = str_split_fixed(colnames(census_c), "!!", 3)[,1]
nrow(census_c)

elims <- census_c[nrow(census_c),] %in% c("Margin of Error", "Percent Margin of Error") 
census_c <- census_c[ ,!colnames(census_c) %in% colnames(census_c)[elims]]

#dropping the row we added for elimintation
census_c <- census_c[-nrow(census_c), ]

#dropping columns of NAs
not_all_na <- function(x) any(!is.na(x))
census_c <- census_c %>% select(where(not_all_na))

#census__est <- census_c[!437 %in% c("Margin of Error", "Percent Margin of Error"))

#converting "N" to 0 (this works both for percents and for estimates, and eases inferences versus NA)

census_c <- replace(census_c, census_c == "N", 0)

census2023_c <- census_c

write.csv(census2023_c,"~/Downloads/clean2023census.csv", row.names = FALSE)

```

2012 district census data
```{r, warnings=FALSE}
#working on 2011-2013 average 


census2011 <- read.csv("/Users/liam/Downloads/courses/PLSC_204/ISPS Election Prediction/census_data/clean2011census.csv")
census2013 <- read.csv("/Users/liam/Downloads/courses/PLSC_204/ISPS Election Prediction/census_data/clean2013census.csv")

census2011 <- as.data.frame(census2011)
census2013 <- as.data.frame(census2013)

#symdiff <- \(x, y) setdiff(union(x,y), intersect(x,y))
#setdiff(colnames(census2013_c), colnames(census2011_c))

#trying to make all non-expected character columns numeric

#first identifying the problem columns
elims_11 <- rep(FALSE,ncol(census2011))
for (i in 1:ncol(census2011)) {
  if (sum(is.na(as.numeric(as.character(census2011[,i])))) != 0 & !colnames(census2011)[i] %in% c("Geography", "name", "state", "state_ab", "districtnum", "num", "cd")){
    elims_11[i] <- TRUE    
  }
}
#removing these columns
census2011 <- census2011[ ,!colnames(census2011) %in% colnames(census2011)[elims_11]]

#converting convertible columns to numeric
i <- !colnames(census2011) %in% c("Geography", "name", "state", "state_ab", "districtnum", "num", "cd")
census2011[, i] <- apply(census2011[, i], 2, function(x) as.numeric(as.character(x)))


#first identifying the problem columns
elims_13 <- rep(FALSE,ncol(census2013))
for (i in 1:ncol(census2013)) {
  if (sum(is.na(as.numeric(as.character(census2013[,i])))) != 0 & !colnames(census2013)[i] %in% c("Geography", "name", "state", "state_ab", "districtnum", "num", "cd")){
    elims_13[i] <- TRUE    
  }
}
#removing these columns
census2013 <- census2013[ ,!colnames(census2013) %in% colnames(census2013)[elims_13]]

#converting convertible columns to numeric
i <- !colnames(census2013) %in% c("Geography", "name", "state", "state_ab", "districtnum", "num", "cd")
census2013[, i] <- apply(census2013[, i], 2, function(x) as.numeric(as.character(x)))


#dropping geography and name since they vary over year
census2011 <- census2011[ , !colnames(census2011) %in% c("Geography", "name", "districtnum", "num")]
census2013 <- census2013[ , !colnames(census2013) %in% c("Geography", "name", "districtnum", "num")]


#before binding, it's appropriate to simplify the data
rows11 <- c("Estimate..SEX.AND.AGE..Total.population", "Percent..SEX.AND.AGE..Male", "Percent..SEX.AND.AGE..Under.5.years", "Percent..SEX.AND.AGE..5.to.9.years", "Percent..SEX.AND.AGE..10.to.14.years", "Percent..SEX.AND.AGE..15.to.19.years", "Percent..SEX.AND.AGE..20.to.24.years", "Percent..SEX.AND.AGE..25.to.34.years", "Percent..SEX.AND.AGE..35.to.44.years", "Percent..SEX.AND.AGE..45.to.54.years", "Percent..SEX.AND.AGE..55.to.59.years", "Percent..SEX.AND.AGE..60.to.64.years", "Percent..SEX.AND.AGE..65.to.74.years", "Percent..SEX.AND.AGE..75.to.84.years", "Percent..SEX.AND.AGE..85.years.and.over", "Estimate..SEX.AND.AGE..Median.age..years.", "Percent..SEX.AND.AGE..18.years.and.over", "Percent..SEX.AND.AGE..21.years.and.over", "Percent..SEX.AND.AGE..65.years.and.over", "Percent..RACE..One.race", "Percent..RACE..Two.or.more.races", "Percent..RACE..White", "Percent..RACE..Black.or.African.American", "Percent..RACE..American.Indian.and.Alaska.Native", "Percent..RACE..Asian", "Percent..RACE..Native.Hawaiian.and.Other.Pacific.Islander", "Percent..RACE..One.race..Some.other.race", "Percent..HISPANIC.OR.LATINO.AND.RACE..Hispanic.or.Latino..of.any.race.", "Percent..HISPANIC.OR.LATINO.AND.RACE..Hispanic.or.Latino..of.any.race...Mexican", "Percent..HISPANIC.OR.LATINO.AND.RACE..Hispanic.or.Latino..of.any.race...Puerto.Rican", "Percent..HISPANIC.OR.LATINO.AND.RACE..Hispanic.or.Latino..of.any.race...Cuban", "Estimate..Total.housing.units", "state", "state_ab", "cd")

rows_nice <- c("total_population", "pct_male", "pct_18_and_older", "pct_senior", "median_age", "pct_white", "pct_black", "pct_amer_indian", "pct_asian", "pct_pi", "pct_latino", "total_housing_units", "state", "state_ab", "cd")

census2011_collapse <- select(census2011, all_of(rows11)) %>% rename(
               total_population = `Estimate..SEX.AND.AGE..Total.population`, 
               pct_male = `Percent..SEX.AND.AGE..Male`,
               pct_18_and_older = `Percent..SEX.AND.AGE..18.years.and.over`,
               pct_senior = `Percent..SEX.AND.AGE..65.years.and.over`,
               median_age = `Estimate..SEX.AND.AGE..Median.age..years.`,
               pct_white = `Percent..RACE..White`,
               pct_black = `Percent..RACE..Black.or.African.American`,
               pct_amer_indian = `Percent..RACE..American.Indian.and.Alaska.Native`,
               pct_asian = `Percent..RACE..Asian`,
               pct_pi = `Percent..RACE..Native.Hawaiian.and.Other.Pacific.Islander`,
               pct_latino = `Percent..HISPANIC.OR.LATINO.AND.RACE..Hispanic.or.Latino..of.any.race.`,
               total_housing_units = `Estimate..Total.housing.units`
               )

census2011_collabse_b <- select(census2011_collapse, all_of(rows_nice))

rows13 <- c("Estimate..SEX.AND.AGE..Total.population", "Percent..SEX.AND.AGE..Total.population..Male", "Percent..SEX.AND.AGE..Under.5.years", "Percent..SEX.AND.AGE..5.to.9.years", "Percent..SEX.AND.AGE..10.to.14.years", "Percent..SEX.AND.AGE..15.to.19.years", "Percent..SEX.AND.AGE..20.to.24.years", "Percent..SEX.AND.AGE..25.to.34.years", "Percent..SEX.AND.AGE..35.to.44.years", "Percent..SEX.AND.AGE..45.to.54.years", "Percent..SEX.AND.AGE..55.to.59.years", "Percent..SEX.AND.AGE..60.to.64.years", "Percent..SEX.AND.AGE..65.to.74.years", "Percent..SEX.AND.AGE..75.to.84.years", "Percent..SEX.AND.AGE..85.years.and.over", "Estimate..SEX.AND.AGE..Median.age..years.", "Percent..SEX.AND.AGE..18.years.and.over", "Percent..SEX.AND.AGE..21.years.and.over", "Percent..SEX.AND.AGE..65.years.and.over", "Percent..RACE..Total.population..One.race", "Percent..RACE..Total.population..Two.or.more.races", "Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..White", "Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Black.or.African.American", "Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..American.Indian.and.Alaska.Native", "Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Asian", "Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Native.Hawaiian.and.Other.Pacific.Islander", "Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Some.other.race", "Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race.", "Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race...Mexican", "Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race...Puerto.Rican", "Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race...Cuban", "Estimate..Total.housing.units", "state", "state_ab", "cd")

census2013_collapse <- select(census2013, all_of(rows13)) %>% rename(
               total_population = `Estimate..SEX.AND.AGE..Total.population`, 
               pct_male = `Percent..SEX.AND.AGE..Total.population..Male`,
               pct_18_and_older = `Percent..SEX.AND.AGE..18.years.and.over`,
               pct_senior = `Percent..SEX.AND.AGE..65.years.and.over`,
               median_age = `Estimate..SEX.AND.AGE..Median.age..years.`,
               pct_white = `Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..White`,
               pct_black = `Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Black.or.African.American`,
               pct_amer_indian = `Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..American.Indian.and.Alaska.Native`,
               pct_asian = `Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Asian`,
               pct_pi = `Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Native.Hawaiian.and.Other.Pacific.Islander`,
               pct_latino = `Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race.`,
               total_housing_units = `Estimate..Total.housing.units`
               )

census2013_collabse_b <- select(census2013_collapse, all_of(rows_nice))

#districts that changed between the two datasets
symdiff <- \(x, y) setdiff(union(x,y), intersect(x,y))
cd_change <- symdiff(census2013$cd, census2011$cd)

#fill = TRUE for column not defined in the first (I'm not sure about this)
census2012_collapse <- rbindlist(list(census_2011_collabse_b, census2013_collabse_b), fill = TRUE)[,lapply(.SD,mean), list(state, state_ab, cd)] 

#adding a year variable
census2012_collapse$year <- 2012
census2012_collapse <- census2012_collapse %>%
  mutate(average = if_else(cd %in% cd_change, FALSE, TRUE))

#write.csv(census2012_collapse,"~/Downloads/census2012collapse.csv", row.names = FALSE)
```

2016 district census data
```{r, warnings=FALSE}
#working on 2015-2017 average 

census1 <- read.csv("/Users/liam/Downloads/courses/PLSC_204/ISPS Election Prediction/census_data/clean2015census.csv")
census2 <- read.csv("/Users/liam/Downloads/courses/PLSC_204/ISPS Election Prediction/census_data/clean2017census.csv")

#census1 <- as.data.frame(census1)
#census2 <- as.data.frame(census2)

#symdiff <- \(x, y) setdiff(union(x,y), intersect(x,y))
#setdiff(colnames(census2013_c), colnames(census2011_c))

#trying to make all non-expected character columns numeric

#first identifying the problem columns
elims_1 <- rep(FALSE,ncol(census1))
for (i in 1:ncol(census1)) {
  if (sum(is.na(as.numeric(as.character(census1[,i])))) != 0 & !colnames(census1)[i] %in% c("Geography", "name", "state", "state_ab", "districtnum", "num", "cd")){
    elims_1[i] <- TRUE    
  }
}
#removing these columns
census1 <- census1[ ,!colnames(census1) %in% colnames(census1)[elims_1]]

#converting convertible columns to numeric
i <- !colnames(census1) %in% c("Geography", "name", "state", "state_ab", "districtnum", "num", "cd")
census1[, i] <- apply(census1[, i], 2, function(x) as.numeric(as.character(x)))


#first identifying the problem columns
elims_2 <- rep(FALSE,ncol(census2))
for (i in 1:ncol(census2)) {
  if (sum(is.na(as.numeric(as.character(census2[,i])))) != 0 & !colnames(census2)[i] %in% c("Geography", "name", "state", "state_ab", "districtnum", "num", "cd")){
    elims_2[i] <- TRUE    
  }
}
#removing these columns
census2 <- census2[ ,!colnames(census2) %in% colnames(census2)[elims_2]]

#converting convertible columns to numeric
i <- !colnames(census2) %in% c("Geography", "name", "state", "state_ab", "districtnum", "num", "cd")
census2[, i] <- apply(census2[, i], 2, function(x) as.numeric(as.character(x)))


#dropping geography and name since they vary over year
census1 <- census1[ , !colnames(census1) %in% c("Geography", "name", "districtnum", "num")]
census2 <- census2[ , !colnames(census2) %in% c("Geography", "name", "districtnum", "num")]

#before binding, it's appropriate to simplify the data
rows1 <- c("Estimate..SEX.AND.AGE..Total.population", "Percent..SEX.AND.AGE..Total.population..Male", "Percent..SEX.AND.AGE..Under.5.years", "Percent..SEX.AND.AGE..5.to.9.years", "Percent..SEX.AND.AGE..10.to.14.years", "Percent..SEX.AND.AGE..15.to.19.years", "Percent..SEX.AND.AGE..20.to.24.years", "Percent..SEX.AND.AGE..25.to.34.years", "Percent..SEX.AND.AGE..35.to.44.years", "Percent..SEX.AND.AGE..45.to.54.years", "Percent..SEX.AND.AGE..55.to.59.years", "Percent..SEX.AND.AGE..60.to.64.years", "Percent..SEX.AND.AGE..65.to.74.years", "Percent..SEX.AND.AGE..75.to.84.years", "Percent..SEX.AND.AGE..85.years.and.over", "Estimate..SEX.AND.AGE..Median.age..years.", "Percent..SEX.AND.AGE..18.years.and.over", "Percent..SEX.AND.AGE..21.years.and.over", "Percent..SEX.AND.AGE..65.years.and.over", "Percent..RACE..Total.population..One.race", "Percent..RACE..Total.population..Two.or.more.races", "Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..White", "Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Black.or.African.American", "Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..American.Indian.and.Alaska.Native", "Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Asian", "Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Native.Hawaiian.and.Other.Pacific.Islander", "Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Some.other.race", "Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race.", "Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race...Mexican", "Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race...Puerto.Rican", "Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race...Cuban", "Estimate..Total.housing.units", "Estimate..CITIZEN..VOTING.AGE.POPULATION..Citizen..18.and.over.population", "state", "state_ab", "cd")

rows_nice <- c("total_population", "pct_male", "pct_18_and_older", "pct_senior", "median_age", "pct_white", "pct_black", "pct_amer_indian", "pct_asian", "pct_pi", "pct_latino", "total_housing_units", "est_voting_age_pop", "state", "state_ab", "cd")

census1_collapse <- select(census1, all_of(rows1)) %>% rename(
               total_population = `Estimate..SEX.AND.AGE..Total.population`, 
               pct_male = `Percent..SEX.AND.AGE..Total.population..Male`,
               pct_18_and_older = `Percent..SEX.AND.AGE..18.years.and.over`,
               pct_senior = `Percent..SEX.AND.AGE..65.years.and.over`,
               median_age = `Estimate..SEX.AND.AGE..Median.age..years.`,
               pct_white = `Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..White`,
               pct_black = `Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Black.or.African.American`,
               pct_amer_indian = `Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..American.Indian.and.Alaska.Native`,
               pct_asian = `Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Asian`,
               pct_pi = `Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Native.Hawaiian.and.Other.Pacific.Islander`,
               pct_latino = `Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race.`,
               total_housing_units = `Estimate..Total.housing.units`,
               est_voting_age_pop = `Estimate..CITIZEN..VOTING.AGE.POPULATION..Citizen..18.and.over.population` 
               )

census1_collabse_b <- select(census1_collapse, all_of(rows_nice))

rows2 <- c("Estimate..SEX.AND.AGE..Total.population", "Percent..SEX.AND.AGE..Total.population..Male", "Percent..SEX.AND.AGE..Under.5.years", "Percent..SEX.AND.AGE..5.to.9.years", "Percent..SEX.AND.AGE..10.to.14.years", "Percent..SEX.AND.AGE..15.to.19.years", "Percent..SEX.AND.AGE..20.to.24.years", "Percent..SEX.AND.AGE..25.to.34.years", "Percent..SEX.AND.AGE..35.to.44.years", "Percent..SEX.AND.AGE..45.to.54.years", "Percent..SEX.AND.AGE..55.to.59.years", "Percent..SEX.AND.AGE..60.to.64.years", "Percent..SEX.AND.AGE..65.to.74.years", "Percent..SEX.AND.AGE..75.to.84.years", "Percent..SEX.AND.AGE..85.years.and.over", "Estimate..SEX.AND.AGE..Median.age..years.", "Percent..SEX.AND.AGE..18.years.and.over", "Percent..SEX.AND.AGE..21.years.and.over", "Percent..SEX.AND.AGE..65.years.and.over", "Percent..RACE..Total.population..One.race", "Percent..RACE..Total.population..Two.or.more.races", "Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..White", "Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Black.or.African.American", "Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..American.Indian.and.Alaska.Native", "Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Asian", "Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Native.Hawaiian.and.Other.Pacific.Islander", "Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Some.other.race", "Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race.", "Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race...Mexican", "Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race...Puerto.Rican", "Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race...Cuban", "Estimate..Total.housing.units", "Estimate..CITIZEN..VOTING.AGE.POPULATION..Citizen..18.and.over.population", "state", "state_ab", "cd")

census2_collapse <- select(census2, all_of(rows2)) %>% rename(
               total_population = `Estimate..SEX.AND.AGE..Total.population`, 
               pct_male = `Percent..SEX.AND.AGE..Total.population..Male`,
               pct_18_and_older = `Percent..SEX.AND.AGE..18.years.and.over`,
               pct_senior = `Percent..SEX.AND.AGE..65.years.and.over`,
               median_age = `Estimate..SEX.AND.AGE..Median.age..years.`,
               pct_white = `Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..White`,
               pct_black = `Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Black.or.African.American`,
               pct_amer_indian = `Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..American.Indian.and.Alaska.Native`,
               pct_asian = `Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Asian`,
               pct_pi = `Percent..RACE..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Native.Hawaiian.and.Other.Pacific.Islander`,
               pct_latino = `Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race.`,
               total_housing_units = `Estimate..Total.housing.units`,
               est_voting_age_pop = `Estimate..CITIZEN..VOTING.AGE.POPULATION..Citizen..18.and.over.population` 
               )

census2_collabse_b <- select(census2_collapse, all_of(rows_nice))

#districts that changed between the two datasets
symdiff <- \(x, y) setdiff(union(x,y), intersect(x,y))
cd_change <- symdiff(census1$cd, census2$cd) #0 so no need to add the average variable this time

#fill = TRUE for column not defined in the first (I'm not sure about this)
census2016_collapse <- rbindlist(list(census1_collabse_b, census2_collabse_b), fill = TRUE)[,lapply(.SD,mean), list(state, state_ab, cd)] 

#adding a year variable
census2016_collapse$year <- 2016
census2016_collapse$average <- TRUE
census2016_collapse$voting_age_pop_over_total = census2016_collapse$est_voting_age_pop/census2016_collapse$total_population*100

write.csv(census2016_collapse,"~/Downloads/census2016collapse.csv", row.names = FALSE)
```

2020 district census data
```{r, warnings=FALSE}
#working on 2019-2021 average 

census1 <- read.csv("/Users/liam/Downloads/courses/PLSC_204/ISPS Election Prediction/census_data/clean2019census.csv")
census2 <- read.csv("/Users/liam/Downloads/courses/PLSC_204/ISPS Election Prediction/census_data/clean2021census.csv")

#census1 <- as.data.frame(census1)
#census2 <- as.data.frame(census2)

#symdiff <- \(x, y) setdiff(union(x,y), intersect(x,y))
#setdiff(colnames(census2013_c), colnames(census2011_c))

#trying to make all non-expected character columns numeric

#first identifying the problem columns
elims_1 <- rep(FALSE,ncol(census1))
for (i in 1:ncol(census1)) {
  if (sum(is.na(as.numeric(as.character(census1[,i])))) != 0 & !colnames(census1)[i] %in% c("Geography", "name", "state", "state_ab", "districtnum", "num", "cd")){
    elims_1[i] <- TRUE    
  }
}
#removing these columns
census1 <- census1[ ,!colnames(census1) %in% colnames(census1)[elims_1]]

#converting convertible columns to numeric
i <- !colnames(census1) %in% c("Geography", "name", "state", "state_ab", "districtnum", "num", "cd")
census1[, i] <- apply(census1[, i], 2, function(x) as.numeric(as.character(x)))


#first identifying the problem columns
elims_2 <- rep(FALSE,ncol(census2))
for (i in 1:ncol(census2)) {
  if (sum(is.na(as.numeric(as.character(census2[,i])))) != 0 & !colnames(census2)[i] %in% c("Geography", "name", "state", "state_ab", "districtnum", "num", "cd")){
    elims_2[i] <- TRUE    
  }
}
#removing these columns
census2 <- census2[ ,!colnames(census2) %in% colnames(census2)[elims_2]]

#converting convertible columns to numeric
i <- !colnames(census2) %in% c("Geography", "name", "state", "state_ab", "districtnum", "num", "cd")
census2[, i] <- apply(census2[, i], 2, function(x) as.numeric(as.character(x)))


#dropping geography and name since they vary over year
census1 <- census1[ , !colnames(census1) %in% c("Geography", "name", "districtnum", "num")]
census2 <- census2[ , !colnames(census2) %in% c("Geography", "name", "districtnum", "num")]

#before binding, it's appropriate to simplify the data
rows1 <- c("Estimate..SEX.AND.AGE..Total.population", "Percent..SEX.AND.AGE..Total.population..Male", "Percent..SEX.AND.AGE..Total.population..Under.5.years", "Percent..SEX.AND.AGE..Total.population..5.to.9.years", "Percent..SEX.AND.AGE..Total.population..10.to.14.years", "Percent..SEX.AND.AGE..Total.population..15.to.19.years", "Percent..SEX.AND.AGE..Total.population..20.to.24.years", "Percent..SEX.AND.AGE..Total.population..25.to.34.years", "Percent..SEX.AND.AGE..Total.population..35.to.44.years", "Percent..SEX.AND.AGE..Total.population..45.to.54.years", "Percent..SEX.AND.AGE..Total.population..55.to.59.years", "Percent..SEX.AND.AGE..Total.population..60.to.64.years", "Percent..SEX.AND.AGE..Total.population..65.to.74.years", "Percent..SEX.AND.AGE..Total.population..75.to.84.years", "Percent..SEX.AND.AGE..Total.population..85.years.and.over", "Estimate..SEX.AND.AGE..Total.population..Median.age..years.", "Percent..SEX.AND.AGE..Total.population..18.years.and.over", "Percent..SEX.AND.AGE..Total.population..21.years.and.over", "Percent..SEX.AND.AGE..Total.population..65.years.and.over", "Percent..RACE..Total.population..One.race", "Percent..RACE..Total.population..Two.or.more.races", "Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..White", "Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Black.or.African.American", "Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..American.Indian.and.Alaska.Native", "Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Asian", "Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Native.Hawaiian.and.Other.Pacific.Islander", "Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Some.other.race", "Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race.", "Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race...Mexican", "Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race...Puerto.Rican", "Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race...Cuban", "Estimate..Total.housing.units", "Estimate..CITIZEN..VOTING.AGE.POPULATION..Citizen..18.and.over.population", "state", "state_ab", "cd")

rows_nice <- c("total_population", "pct_male", "pct_18_and_older", "pct_senior", "median_age", "pct_white", "pct_black", "pct_amer_indian", "pct_asian", "pct_pi", "pct_latino", "total_housing_units", "est_voting_age_pop", "state", "state_ab", "cd")

census1_collapse <- select(census1, all_of(rows1)) %>% rename(
               total_population = `Estimate..SEX.AND.AGE..Total.population`, 
               pct_male = `Percent..SEX.AND.AGE..Total.population..Male`,
               pct_18_and_older = `Percent..SEX.AND.AGE..Total.population..18.years.and.over`,
               pct_senior = `Percent..SEX.AND.AGE..Total.population..65.years.and.over`,
               median_age = `Estimate..SEX.AND.AGE..Total.population..Median.age..years.`,
               pct_white = `Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..White`,
               pct_black = `Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Black.or.African.American`,
               pct_amer_indian = `Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..American.Indian.and.Alaska.Native`,
               pct_asian = `Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Asian`,
               pct_pi = `Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Native.Hawaiian.and.Other.Pacific.Islander`,
               pct_latino = `Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race.`,
               total_housing_units = `Estimate..Total.housing.units`,
               est_voting_age_pop = `Estimate..CITIZEN..VOTING.AGE.POPULATION..Citizen..18.and.over.population`
               )

census1_collabse_b <- select(census1_collapse, all_of(rows_nice))


rows2 <- c("Estimate..SEX.AND.AGE..Total.population", "Percent..SEX.AND.AGE..Total.population..Male", "Percent..SEX.AND.AGE..Total.population..Under.5.years", "Percent..SEX.AND.AGE..Total.population..5.to.9.years", "Percent..SEX.AND.AGE..Total.population..10.to.14.years", "Percent..SEX.AND.AGE..Total.population..15.to.19.years", "Percent..SEX.AND.AGE..Total.population..20.to.24.years", "Percent..SEX.AND.AGE..Total.population..25.to.34.years", "Percent..SEX.AND.AGE..Total.population..35.to.44.years", "Percent..SEX.AND.AGE..Total.population..45.to.54.years", "Percent..SEX.AND.AGE..Total.population..55.to.59.years", "Percent..SEX.AND.AGE..Total.population..60.to.64.years", "Percent..SEX.AND.AGE..Total.population..65.to.74.years", "Percent..SEX.AND.AGE..Total.population..75.to.84.years", "Percent..SEX.AND.AGE..Total.population..85.years.and.over", "Estimate..SEX.AND.AGE..Total.population..Median.age..years.", "Percent..SEX.AND.AGE..Total.population..18.years.and.over", "Percent..SEX.AND.AGE..Total.population..21.years.and.over", "Percent..SEX.AND.AGE..Total.population..65.years.and.over", "Percent..RACE..Total.population..One.race", "Percent..RACE..Total.population..Two.or.more.races", "Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..White", "Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Black.or.African.American", "Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..American.Indian.and.Alaska.Native", "Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Asian", "Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Native.Hawaiian.and.Other.Pacific.Islander", "Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Some.other.race", "Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race.", "Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race...Mexican", "Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race...Puerto.Rican", "Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race...Cuban", "Estimate..Total.housing.units", "Estimate..CITIZEN..VOTING.AGE.POPULATION..Citizen..18.and.over.population", "state", "state_ab", "cd")

census2_collapse <- select(census2, all_of(rows2)) %>% rename(
               total_population = `Estimate..SEX.AND.AGE..Total.population`, 
               pct_male = `Percent..SEX.AND.AGE..Total.population..Male`,
               pct_18_and_older = `Percent..SEX.AND.AGE..Total.population..18.years.and.over`,
               pct_senior = `Percent..SEX.AND.AGE..Total.population..65.years.and.over`,
               median_age = `Estimate..SEX.AND.AGE..Total.population..Median.age..years.`,
               pct_white = `Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..White`,
               pct_black = `Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Black.or.African.American`,
               pct_amer_indian = `Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..American.Indian.and.Alaska.Native`,
               pct_asian = `Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Asian`,
               pct_pi = `Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Native.Hawaiian.and.Other.Pacific.Islander`,
               pct_latino = `Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race.`,
               total_housing_units = `Estimate..Total.housing.units`,
               est_voting_age_pop = `Estimate..CITIZEN..VOTING.AGE.POPULATION..Citizen..18.and.over.population`
               )

census2_collabse_b <- select(census2_collapse, all_of(rows_nice))

#districts that changed between the two datasets
symdiff <- \(x, y) setdiff(union(x,y), intersect(x,y))
cd_change <- symdiff(census1$cd, census2$cd) #0 so no need to add the average variable this time

#fill = TRUE for column not defined in the first (I'm not sure about this)
census2020_collapse <- rbindlist(list(census1_collabse_b, census2_collabse_b), fill = TRUE)[,lapply(.SD,mean), list(state, state_ab, cd)] 

#adding a year variable
census2020_collapse$year <- 2020
census2020_collapse$average <- TRUE
census2020_collapse$voting_age_pop_over_total <- census2020_collapse$est_voting_age_pop/census2020_collapse$total_population*100

write.csv(census2020_collapse,"~/Downloads/census2020collapse.csv", row.names = FALSE)
```

2024 district census data
```{r}
#working on 2023 collapse

census1 <- read.csv("/Users/liam/Downloads/courses/PLSC_204/ISPS Election Prediction/census_data/clean2023census.csv")

#trying to make all non-expected character columns numeric

#first identifying the problem columns
elims_1 <- rep(FALSE,ncol(census1))
for (i in 1:ncol(census1)) {
  if (sum(is.na(as.numeric(as.character(census1[,i])))) != 0 & !colnames(census1)[i] %in% c("Geography", "name", "state", "state_ab", "districtnum", "num", "cd")){
    elims_1[i] <- TRUE    
  }
}
#removing these columns
census1 <- census1[ ,!colnames(census1) %in% colnames(census1)[elims_1]]

#converting convertible columns to numeric
i <- !colnames(census1) %in% c("Geography", "name", "state", "state_ab", "districtnum", "num", "cd")
census1[, i] <- apply(census1[, i], 2, function(x) as.numeric(as.character(x)))


#dropping geography and name since they vary over year
census1 <- census1[ , !colnames(census1) %in% c("Geography", "name", "districtnum", "num")]

#before binding, it's appropriate to simplify the data
rows1 <- c("Estimate..SEX.AND.AGE..Total.population", "Percent..SEX.AND.AGE..Total.population..Male", "Percent..SEX.AND.AGE..Total.population..Under.5.years", "Percent..SEX.AND.AGE..Total.population..5.to.9.years", "Percent..SEX.AND.AGE..Total.population..10.to.14.years", "Percent..SEX.AND.AGE..Total.population..15.to.19.years", "Percent..SEX.AND.AGE..Total.population..20.to.24.years", "Percent..SEX.AND.AGE..Total.population..25.to.34.years", "Percent..SEX.AND.AGE..Total.population..35.to.44.years", "Percent..SEX.AND.AGE..Total.population..45.to.54.years", "Percent..SEX.AND.AGE..Total.population..55.to.59.years", "Percent..SEX.AND.AGE..Total.population..60.to.64.years", "Percent..SEX.AND.AGE..Total.population..65.to.74.years", "Percent..SEX.AND.AGE..Total.population..75.to.84.years", "Percent..SEX.AND.AGE..Total.population..85.years.and.over", "Estimate..SEX.AND.AGE..Total.population..Median.age..years.", "Percent..SEX.AND.AGE..Total.population..18.years.and.over", "Percent..SEX.AND.AGE..Total.population..21.years.and.over", "Percent..SEX.AND.AGE..Total.population..65.years.and.over", "Percent..RACE..Total.population..One.race", "Percent..RACE..Total.population..Two.or.More.Races", "Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..White", "Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Black.or.African.American", "Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..American.Indian.and.Alaska.Native", "Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Asian", "Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Native.Hawaiian.and.Other.Pacific.Islander", "Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Some.Other.Race", "Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race.", "Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race...Mexican", "Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race...Puerto.Rican", "Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race...Cuban", "Estimate..Total.housing.units", "Estimate..CITIZEN..VOTING.AGE.POPULATION..Citizen..18.and.over.population", "state", "state_ab", "cd")

rows_nice <- c("total_population", "pct_male", "pct_18_and_older", "pct_senior", "median_age", "pct_white", "pct_black", "pct_amer_indian", "pct_asian", "pct_pi", "pct_latino", "total_housing_units", "est_voting_age_pop", "state", "state_ab", "cd")

census1_collapse <- select(census1, all_of(rows1)) %>% rename(
               total_population = `Estimate..SEX.AND.AGE..Total.population`, 
               pct_male = `Percent..SEX.AND.AGE..Total.population..Male`,
               pct_18_and_older = `Percent..SEX.AND.AGE..Total.population..18.years.and.over`,
               pct_senior = `Percent..SEX.AND.AGE..Total.population..65.years.and.over`,
               median_age = `Estimate..SEX.AND.AGE..Total.population..Median.age..years.`,
               pct_white = `Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..White`,
               pct_black = `Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Black.or.African.American`,
               pct_amer_indian = `Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..American.Indian.and.Alaska.Native`,
               pct_asian = `Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Asian`,
               pct_pi = `Percent..Race.alone.or.in.combination.with.one.or.more.other.races..Total.population..Native.Hawaiian.and.Other.Pacific.Islander`,
               pct_latino = `Percent..HISPANIC.OR.LATINO.AND.RACE..Total.population..Hispanic.or.Latino..of.any.race.`,
               total_housing_units = `Estimate..Total.housing.units`,
               est_voting_age_pop = `Estimate..CITIZEN..VOTING.AGE.POPULATION..Citizen..18.and.over.population`
               )

census2024_collapse <- select(census1_collapse, all_of(rows_nice))

#adding a year variable
census2024_collapse$year <- 2024
census2024_collapse$average <- FALSE
census2024_collapse$voting_age_pop_over_total <- census2024_collapse$est_voting_age_pop/census2024_collapse$total_population*100

write.csv(census2024_collapse,"~/Downloads/census2024collapse.csv", row.names = FALSE)
```










Merging data on presidential returns with demographic returns
```{r}
#data_complete_plus_dc <- read.csv("/Users/liam/Downloads/courses/PLSC_204/ISPS Election Prediction/data_complete_plus_dc.csv")

#splitting this into statewide data and district wide data

census2012_avg_estimates <- read.csv("/Users/liam/Downloads/courses/PLSC_204/ISPS Election Prediction/census2012collapse.csv")
census2016_avg_estimates <- read.csv("/Users/liam/Downloads/courses/PLSC_204/ISPS Election Prediction/census2016collapse.csv")
census2020_avg_estimates <- read.csv("/Users/liam/Downloads/courses/PLSC_204/ISPS Election Prediction/census2020collapse.csv")
census2024_avg_estimates <- read.csv("/Users/liam/Downloads/courses/PLSC_204/ISPS Election Prediction/census2024collapse.csv")

census2012_avg_estimates$est_voting_age_pop <- NA
census2012_avg_estimates$voting_age_pop_over_total <- NA

collective_census_avg_estimates <- rbind(census2012_avg_estimates, census2016_avg_estimates, census2020_avg_estimates, census2024_avg_estimates)

data_complete_plus_census <- merge(data_complete_plus_dc, collective_census_avg_estimates, by=c("cd","year"))

#write.csv(data_complete_plus_census,"~/Downloads/data_complete_plus_census.csv", row.names = FALSE)

```

#adding in incumbency
```{r}

data_complete <- data_complete_plus_census #moving on, create new dataset

data_complete <- data_complete[,!colnames(data_complete) %in% c("district", "largest_place")]

#adding an office category
data_complete <- data_complete %>%
  mutate(office = ifelse (!is.na(S_total_votes), "S",
         ifelse (!is.na(H_total_votes), "H", "P")))

#make a senate incumbency and house incumbency column
# +1 if Republican is incumbent and Democrat is challenger, 0 if neither (or both?) is incumbent, -1 if Democrat is incumbent and Republican is challenger
# do we have this data for 2024?! that's the most important question first, I think

 #also in key datasets


# filter by relevant years
# add incumbency as described above
# add variable for whether its an unchallenged race
#join by office and year

```


#adding "2024" census data to our dataset, for the upcoming work and state partisanship
```{r}
#use 2023 collapse, really "appending vertically" rather than merging with existing work 
```


#adding a state by state relative partisanship variable (interested in state's relative partisanship in last election also)
#we need this 
```{r}
#summary table by year by year and state for percent for presidentâ€”can subtract from total pct for each year 
#we could also look for a CPVI (Cook Partisan Voting Index) table â€” looking into it more, this is what I'd recommend
# https://www.cookpolitical.com/cook-pvi
# I bought a 24 hour subscription, and uploading these to drive (they can't be circualted per the IP policy, but I think we can use them in our model)


```











